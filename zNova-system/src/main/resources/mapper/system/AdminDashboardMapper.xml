<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zNova.system.mapper.AdminDashboardMapper">

    <resultMap type="com.zNova.system.domain.vo.AdminDashboardStatsVO" id="AdminDashboardStatsVOMap">
        <result property="totalConsumerCount" column="total_consumer_count" />
        <result property="totalMerchantCount" column="total_merchant_count" />
        <result property="totalTransactionAmount" column="total_transaction_amount" />
        <result property="totalOrderCount" column="total_order_count" />
    </resultMap>

    <!-- 查询C端用户总数 -->
    <select id="selectTotalConsumerCount" resultType="java.lang.Long">
        SELECT COUNT(*) FROM app_user
    </select>

    <!-- 查询商家总数（角色为'common'的用户） -->
    <select id="selectTotalMerchantCount" resultType="java.lang.Long">
        SELECT COUNT(DISTINCT su.user_id)
        FROM sys_user su
                 INNER JOIN sys_user_role sur ON su.user_id = sur.user_id
                 INNER JOIN sys_role sr ON sur.role_id = sr.role_id
        WHERE sr.role_key = 'common'
    </select>

    <!-- 查询平台累计交易额 -->
    <select id="selectTotalTransactionAmount" resultType="java.lang.Double">
        SELECT IFNULL(SUM(
                              CASE
                                  WHEN soi.business_type = '2' THEN soi.price * soi.quantity
                                  WHEN soi.business_type = '1' THEN soi.price * soi.rent_days
                                  ELSE 0
                                  END
                      ), 0) AS total_transaction_amount
        FROM shop_order_item soi
                 INNER JOIN shop_order so ON soi.order_id = so.order_id
        WHERE so.status = '3'
    </select>

    <!-- 查询平台累计订单数 -->
    <select id="selectTotalOrderCount" resultType="java.lang.Long">
        SELECT COUNT(*) FROM shop_order
    </select>

    <!-- 查询近30天系统访问趋势 -->
    <select id="selectRecent30DaysVisitTrend" resultType="java.util.Map">
        SELECT
            DATE_FORMAT(login_time, '%Y-%m-%d') AS dateStr,
            COUNT(DISTINCT user_name) AS userCount
        FROM
            sys_logininfor
        WHERE
            status = '0'
          AND login_time >= DATE_SUB(CURDATE(), INTERVAL 29 DAY)
        GROUP BY
            DATE_FORMAT(login_time, '%Y-%m-%d')
        ORDER BY
            dateStr
    </select>
</mapper>