<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zNova.system.mapper.BizProductMapper">

    <!-- 在resultMap中添加deptId映射 -->
    <resultMap type="BizProduct" id="BizProductResult">
        <!-- 现有字段映射 -->
        <result property="id" column="id" />
        <result property="productName" column="product_name" />
        <result property="productType" column="product_type" />
        <result property="rentPrice" column="rent_price" />
        <result property="salePrice" column="sale_price" />
        <result property="stockQuantity" column="stock_quantity" />
        <result property="availableRent" column="available_rent" />
        <result property="cpu" column="cpu" />
        <result property="motherboard" column="motherboard" />
        <result property="memory" column="memory" />
        <result property="ssd" column="ssd" />
        <result property="graphicsCard" column="graphics_card" />
        <result property="cooler" column="cooler" />
        <result property="powerSupply" column="power_supply" />
        <result property="chassis" column="chassis" />
        <result property="imageUrl" column="image_url" />
        <result property="status" column="status" />
        <result property="createBy" column="create_by" />
        <result property="createTime" column="create_time" />
        <result property="updateBy" column="update_by" />
        <result property="updateTime" column="update_time" />
        <result property="remark" column="remark" />
        <!-- 新增的性能字段映射 -->
        <result property="cpuBrand" column="cpuBrand" />
        <result property="cpuSingleCoreScore" column="cpuSingleCoreScore" />
        <result property="cpuMultiCoreScore" column="cpuMultiCoreScore" />
        <result property="gpuScore" column="gpuScore" />
        <!-- 保持原有的映射 -->
        <result property="gpuModel" column="gpu_model" />
        <result property="memoryType" column="memory_type" />
        <result property="memoryFrequency" column="memory_frequency" />
        <!-- 添加deptId映射 -->
        <result property="deptId" column="dept_id" />
        <result property="deptName" column="dept_name" />
        <!-- 性能分数映射 -->
        <result property="performanceScore" column="performance_score" />
    </resultMap>

    <sql id="selectBizProductVo">
        select
        p.id, p.product_name, p.product_type, p.rent_price, p.sale_price, p.stock_quantity, p.available_rent,
        p.cpu, p.motherboard, p.memory, p.ssd, p.graphics_card, p.cooler, p.power_supply, p.chassis,
        p.image_url, p.status, p.create_by, p.create_time, p.update_by, p.update_time, p.remark,
        p.gpu_model, p.memory_type, p.memory_frequency, p.dept_id, p.performance_score, d.dept_name,
        <!-- 从硬件表获取性能数据 -->
        c.brand as cpuBrand,
        c.single_core_score as cpuSingleCoreScore,
        c.multi_core_score as cpuMultiCoreScore,
        g.performance_score as gpuScore
        from biz_product p
        <!-- 关联CPU表（通过p.cpu = c.model） -->
        left join hardware_cpu c on p.cpu = c.model
        <!-- 关联GPU表（通过p.gpu_model = g.model） -->
        left join hardware_gpu g on p.gpu_model = g.model
        /* 3. 添加关联 sys_dept 表 */
        left join sys_dept d on p.dept_id = d.dept_id

    </sql>

    <select id="selectBizProductList" parameterType="BizProduct" resultMap="BizProductResult">
        <include refid="selectBizProductVo"/>
        <where>
            <if test="productName != null and productName != ''">
                and p.product_name like concat('%', #{productName}, '%')
            </if>
            <if test="productType != null and productType != ''">
                and p.product_type = #{productType}
            </if>
            ${params.dataScope}

            <!-- 新增：处理hasRent参数，查询可租赁的商品（含租售一体） -->
            <if test="hasRent != null and hasRent == true">
                and p.product_type IN ('1', '3')  <!-- 1=租赁，3=租售一体 -->
            </if>

            <!-- 新增：处理hasSale参数，查询可销售的商品（含租售一体） -->
            <if test="hasSale != null and hasSale == true">
                and p.product_type IN ('2', '3')  <!-- 2=销售，3=租售一体 -->
            </if>
            <if test="salePrice != null ">
                and p.sale_price = #{salePrice}
            </if>
            <if test="cpu != null and cpu != ''">
                and p.cpu like concat('%', #{cpu}, '%')
            </if>
            <if test="graphicsCard != null and graphicsCard != ''">
                and p.graphics_card like concat('%', #{graphicsCard}, '%')
            </if>
            <if test="status != null and status != ''">
                and p.status = #{status}
            </if>
        </where>
    </select>

    <select id="selectBizProductById" parameterType="Long" resultMap="BizProductResult">
        <include refid="selectBizProductVo"/>
        where p.id = #{id}
    </select>

    <!-- 保留一个insertBizProduct方法并添加dept_id字段 -->
    <insert id="insertBizProduct" parameterType="BizProduct" useGeneratedKeys="true" keyProperty="id">
        insert into biz_product
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="productName != null and productName != ''">product_name,</if>
            <if test="productType != null">product_type,</if>
            <if test="rentPrice != null">rent_price,</if>
            <if test="salePrice != null">sale_price,</if>
            <if test="stockQuantity != null">stock_quantity,</if>
            <if test="availableRent != null">available_rent,</if>
            <if test="cpu != null">cpu,</if>
            <if test="motherboard != null">motherboard,</if>
            <if test="memory != null">memory,</if>
            <if test="ssd != null">ssd,</if>
            <if test="graphicsCard != null">graphics_card,</if>
            <if test="cooler != null">cooler,</if>
            <if test="powerSupply != null">power_supply,</if>
            <if test="chassis != null">chassis,</if>
            <if test="imageUrl != null">image_url,</if>
            <if test="status != null">status,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="remark != null">remark,</if>
            <if test="gpuModel != null">gpu_model,</if>
            <if test="memoryType != null">memory_type,</if>
            <if test="memoryFrequency != null">memory_frequency,</if>
            <if test="performanceScore != null">performance_score,</if>
            <!-- dept_id字段必须插入，不能为空 -->
            dept_id,
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="productName != null and productName != ''">#{productName},</if>
            <if test="productType != null">#{productType},</if>
            <if test="rentPrice != null">#{rentPrice},</if>
            <if test="salePrice != null">#{salePrice},</if>
            <if test="stockQuantity != null">#{stockQuantity},</if>
            <if test="availableRent != null">#{availableRent},</if>
            <if test="cpu != null">#{cpu},</if>
            <if test="motherboard != null">#{motherboard},</if>
            <if test="memory != null">#{memory},</if>
            <if test="ssd != null">#{ssd},</if>
            <if test="graphicsCard != null">#{graphicsCard},</if>
            <if test="cooler != null">#{cooler},</if>
            <if test="powerSupply != null">#{powerSupply},</if>
            <if test="chassis != null">#{chassis},</if>
            <if test="imageUrl != null">#{imageUrl},</if>
            <if test="status != null">#{status},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="remark != null">#{remark},</if>
            <if test="gpuModel != null">#{gpuModel},</if>
            <if test="memoryType != null">#{memoryType},</if>
            <if test="memoryFrequency != null">#{memoryFrequency},</if>
            <if test="performanceScore != null">#{performanceScore},</if>
            <!-- dept_id字段值必须插入 -->
            #{deptId},
        </trim>
    </insert>

    <!-- 在updateBizProduct方法中添加dept_id字段 -->
    <update id="updateBizProduct" parameterType="BizProduct">
        update biz_product
        <trim prefix="SET" suffixOverrides=",">
            <if test="productName != null and productName != ''">product_name = #{productName},</if>
            <if test="productType != null">product_type = #{productType},</if>
            <if test="rentPrice != null">rent_price = #{rentPrice},</if>
            <if test="salePrice != null">sale_price = #{salePrice},</if>
            <if test="stockQuantity != null">stock_quantity = #{stockQuantity},</if>
            <if test="availableRent != null">available_rent = #{availableRent},</if>
            <if test="cpu != null">cpu = #{cpu},</if>
            <if test="motherboard != null">motherboard = #{motherboard},</if>
            <if test="memory != null">memory = #{memory},</if>
            <if test="ssd != null">ssd = #{ssd},</if>
            <if test="graphicsCard != null">graphics_card = #{graphicsCard},</if>
            <if test="cooler != null">cooler = #{cooler},</if>
            <if test="powerSupply != null">power_supply = #{powerSupply},</if>
            <if test="chassis != null">chassis = #{chassis},</if>
            <if test="imageUrl != null">image_url = #{imageUrl},</if>
            <if test="status != null">status = #{status},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="gpuModel != null">gpu_model = #{gpuModel},</if>
            <if test="memoryType != null">memory_type = #{memoryType},</if>
            <if test="memoryFrequency != null">memory_frequency = #{memoryFrequency},</if>
            <if test="performanceScore != null">performance_score = #{performanceScore},</if>
            <!-- 添加dept_id字段更新 -->
            <if test="deptId != null">dept_id = #{deptId},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteBizProductById" parameterType="Long">
        delete from biz_product where id = #{id}
    </delete>

    <delete id="deleteBizProductByIds" parameterType="String">
        delete from biz_product where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    <!-- 查询商品列表（关联部门名称） -->
    <select id="selectBizProductListWithDeptName" parameterType="com.zNova.system.domain.BizProduct" resultMap="BizProductResult">
        SELECT
        p.*,
        d.dept_name as dept_name
        FROM biz_product p
        LEFT JOIN sys_dept d ON p.dept_id = d.dept_id
        <where>
            <!-- 原有查询条件 -->
            ${params.dataScope}
        </where>
        ORDER BY p.id DESC
    </select>
    <update id="decreaseStock">
        UPDATE biz_product
        SET stock_quantity = stock_quantity - #{quantity}
        WHERE id = #{id} AND stock_quantity >= #{quantity}
    </update>

    <update id="increaseStock">
        UPDATE biz_product
        SET stock_quantity = stock_quantity + #{quantity}
        WHERE id = #{id}
    </update>

    <!-- 根据性能分数查询最接近的商品 -->
    <select id="selectProductListByScoreNear" parameterType="int" resultMap="BizProductResult">
        <include refid="selectBizProductVo"/>
        <where>
            p.status = '0' <!-- 只查询上架状态的商品 -->
        </where>
        ORDER BY ABS(p.performance_score - #{targetScore}) ASC
        LIMIT 4
    </select>
</mapper>