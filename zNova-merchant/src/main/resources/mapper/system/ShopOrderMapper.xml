<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zNova.system.mapper.ShopOrderMapper">

    <resultMap type="ShopOrder" id="ShopOrderResult">
        <result property="orderId"    column="order_id"    />
        <result property="orderNo"    column="order_no"    />
        <result property="userId"    column="user_id"    />
        <result property="totalAmount"    column="total_amount"    />
        <result property="status"    column="status"    />
        <result property="payType"    column="pay_type"    />
        <result property="payTime"    column="pay_time"    />
        <result property="receiverName"    column="receiver_name"    />
        <result property="receiverPhone"    column="receiver_phone"    />
        <result property="receiverAddress"    column="receiver_address"    />
        <result property="remark"    column="remark"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateTime"    column="update_time"    />
        <result property="deptId"    column="dept_id"    />
        <result property="depositAmount"    column="deposit_amount"    />
        <result property="isOverdue"    column="is_overdue"    />
    </resultMap>

    <resultMap id="ShopOrderShopOrderItemResult" type="ShopOrder" extends="ShopOrderResult">
        <collection property="shopOrderItemList" ofType="ShopOrderItem" column="order_id" select="selectShopOrderItemList" />
    </resultMap>

    <resultMap type="ShopOrderItem" id="ShopOrderItemResult">
        <result property="id"    column="id"    />
        <result property="orderId"    column="order_id"    />
        <result property="productId"    column="product_id"    />
        <result property="productName"    column="product_name"    />
        <result property="productImg"    column="product_img"    />
        <result property="businessType"    column="business_type"    />
        <result property="price"    column="price"    />
        <result property="quantity"    column="quantity"    />
        <result property="rentStartTime"    column="rent_start_time"    />
        <result property="rentEndTime"    column="rent_end_time"    />
        <result property="rentDays"    column="rent_days"    />
        <result property="deptId"    column="dept_id"    />
        <result property="deposit"    column="deposit"    />
        <result property="overdueDeductDays"    column="overdue_deduct_days"    />
    </resultMap>

    <sql id="selectShopOrderVo">
        select order_id, order_no, user_id, total_amount, status, pay_type, pay_time, receiver_name, receiver_phone, receiver_address, remark, create_time, update_time, dept_id, deposit_amount, is_overdue from shop_order
    </sql>

    <select id="selectShopOrderList" parameterType="ShopOrder" resultMap="ShopOrderResult">
        <include refid="selectShopOrderVo"/>
        <where>
            <if test="orderNo != null  and orderNo != ''"> and order_no = #{orderNo}</if>
            <if test="userId != null "> and user_id = #{userId}</if>
            <if test="totalAmount != null "> and total_amount = #{totalAmount}</if>
            <if test="status != null  and status != ''"> and status = #{status}</if>
            <if test="payType != null  and payType != ''"> and pay_type = #{payType}</if>
            <if test="payTime != null "> and pay_time = #{payTime}</if>
            <if test="receiverName != null  and receiverName != ''"> and receiver_name like concat('%', #{receiverName}, '%')</if>
            <if test="receiverPhone != null  and receiverPhone != ''"> and receiver_phone = #{receiverPhone}</if>
            <if test="receiverAddress != null  and receiverAddress != ''"> and receiver_address = #{receiverAddress}</if>
            <if test="deptId != null "> and dept_id = #{deptId}</if>
        </where>
    </select>

    <select id="selectShopOrderByOrderId" parameterType="Long" resultMap="ShopOrderShopOrderItemResult">
        select order_id, order_no, user_id, total_amount, status, pay_type, pay_time, receiver_name, receiver_phone, receiver_address, remark, create_time, update_time, dept_id, deposit_amount, is_overdue
        from shop_order
        where order_id = #{orderId}
    </select>

    <select id="selectShopOrderItemList" resultMap="ShopOrderItemResult">
        select id, order_id, product_id, product_name, product_img, business_type, price, quantity, rent_start_time, rent_end_time, rent_days, dept_id, deposit, overdue_deduct_days
        from shop_order_item
        where order_id = #{order_id}
    </select>

    <insert id="insertShopOrder" parameterType="ShopOrder" useGeneratedKeys="true" keyProperty="orderId">
        <!-- 新增 selectKey 确保能获取到自增主键 -->
        <selectKey keyProperty="orderId" resultType="long" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
        insert into shop_order
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="orderNo != null and orderNo != ''">order_no,</if>
            <if test="userId != null">user_id,</if>
            <if test="totalAmount != null">total_amount,</if>
            <if test="status != null">status,</if>
            <if test="payType != null">pay_type,</if>
            <if test="payTime != null">pay_time,</if>
            <if test="receiverName != null">receiver_name,</if>
            <if test="receiverPhone != null">receiver_phone,</if>
            <if test="receiverAddress != null">receiver_address,</if>
            <if test="remark != null">remark,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="deptId != null">dept_id,</if>
            <if test="depositAmount != null">deposit_amount,</if>
            <if test="isOverdue != null">is_overdue,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="orderNo != null and orderNo != ''">#{orderNo},</if>
            <if test="userId != null">#{userId},</if>
            <if test="totalAmount != null">#{totalAmount},</if>
            <if test="status != null">#{status},</if>
            <if test="payType != null">#{payType},</if>
            <if test="payTime != null">#{payTime},</if>
            <if test="receiverName != null">#{receiverName},</if>
            <if test="receiverPhone != null">#{receiverPhone},</if>
            <if test="receiverAddress != null">#{receiverAddress},</if>
            <if test="remark != null">#{remark},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="deptId != null">#{deptId},</if>
            <if test="depositAmount != null">#{depositAmount},</if>
            <if test="isOverdue != null">#{isOverdue},</if>
        </trim>
    </insert>

    <update id="updateShopOrder" parameterType="ShopOrder">
        update shop_order
        <trim prefix="SET" suffixOverrides=",">
            <if test="orderNo != null and orderNo != ''">order_no = #{orderNo},</if>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="totalAmount != null">total_amount = #{totalAmount},</if>
            <if test="status != null">status = #{status},</if>
            <if test="payType != null">pay_type = #{payType},</if>
            <if test="payTime != null">pay_time = #{payTime},</if>
            <if test="receiverName != null">receiver_name = #{receiverName},</if>
            <if test="receiverPhone != null">receiver_phone = #{receiverPhone},</if>
            <if test="receiverAddress != null">receiver_address = #{receiverAddress},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="deptId != null">dept_id = #{deptId},</if>
            <if test="depositAmount != null">deposit_amount = #{depositAmount},</if>
            <if test="isOverdue != null">is_overdue = #{isOverdue},</if>
        </trim>
        where order_id = #{orderId}
    </update>

    <delete id="deleteShopOrderByOrderId" parameterType="Long">
        delete from shop_order where order_id = #{orderId}
    </delete>

    <delete id="deleteShopOrderByOrderIds" parameterType="String">
        delete from shop_order where order_id in
        <foreach item="orderId" collection="array" open="(" separator="," close=")">
            #{orderId}
        </foreach>
    </delete>

    <delete id="deleteShopOrderItemByOrderIds" parameterType="String">
        delete from shop_order_item where order_id in
        <foreach item="orderId" collection="array" open="(" separator="," close=")">
            #{orderId}
        </foreach>
    </delete>

    <delete id="deleteShopOrderItemByOrderId" parameterType="Long">
        delete from shop_order_item where order_id = #{orderId}
    </delete>

    <insert id="batchShopOrderItem">
        insert into shop_order_item( order_id, product_id, product_name, product_img, business_type, price, quantity, rent_start_time, rent_end_time, rent_days, dept_id, deposit, overdue_deduct_days) values
        <foreach item="item" index="index" collection="list" separator=",">
            ( #{item.orderId}, #{item.productId}, #{item.productName}, #{item.productImg}, #{item.businessType}, #{item.price}, #{item.quantity}, #{item.rentStartTime}, #{item.rentEndTime}, #{item.rentDays}, #{item.deptId}, #{item.deposit}, #{item.overdueDeductDays})
        </foreach>
    </insert>

    <!-- 逾期订单明细结果映射（包含关联订单信息） -->
    <resultMap type="ShopOrderItem" id="OverdueOrderItemResult">
        <result property="id"    column="id"    />
        <result property="orderId"    column="order_id"    />
        <result property="productId"    column="product_id"    />
        <result property="productName"    column="product_name"    />
        <result property="productImg"    column="product_img"    />
        <result property="businessType"    column="business_type"    />
        <result property="price"    column="price"    />
        <result property="quantity"    column="quantity"    />
        <result property="rentStartTime"    column="rent_start_time"    />
        <result property="rentEndTime"    column="rent_end_time"    />
        <result property="rentDays"    column="rent_days"    />
        <result property="deptId"    column="dept_id"    />
        <result property="deposit"    column="deposit"    />
        <result property="overdueDeductDays"    column="overdue_deduct_days"    />
        <result property="userId"    column="user_id"    />
        <result property="orderDepositAmount"    column="deposit_amount"    />
        <result property="orderIsOverdue"    column="is_overdue"    />
    </resultMap>

    <!-- 查询逾期租赁订单明细 -->
    <!-- 注意：只检查状态2(租赁中)，排除状态7(归还中)，因为用户已点击归还则不再扣押金 -->
    <select id="selectOverdueRentalItems" resultMap="OverdueOrderItemResult">
        SELECT i.id, i.order_id, i.product_id, i.product_name, i.product_img, i.business_type, 
               i.price, i.quantity, i.rent_start_time, i.rent_end_time, i.rent_days, i.dept_id,
               i.deposit, i.overdue_deduct_days, o.user_id, o.deposit_amount, o.is_overdue
        FROM shop_order_item i
        INNER JOIN shop_order o ON i.order_id = o.order_id
        WHERE o.status = '2'
          AND i.business_type = '1'
          AND i.rent_end_time &lt; CURDATE()
    </select>

    <!-- 更新订单明细已扣逾期天数 -->
    <update id="updateOverdueDeductDays">
        UPDATE shop_order_item 
        SET overdue_deduct_days = #{overdueDeductDays}
        WHERE id = #{itemId}
    </update>

    <!-- 扣减订单押金金额 -->
    <update id="deductDepositAmount">
        UPDATE shop_order 
        SET deposit_amount = GREATEST(0, IFNULL(deposit_amount, 0) - #{deductAmount})
        WHERE order_id = #{orderId}
    </update>

    <!-- 标记订单为已逾期 -->
    <update id="markOrderOverdue">
        UPDATE shop_order 
        SET is_overdue = '1'
        WHERE order_id = #{orderId} AND (is_overdue IS NULL OR is_overdue = '0')
    </update>

    <!-- 查询即将到期的租赁订单明细（用于定时任务） -->
    <select id="selectExpiringSoonItems" resultMap="OverdueOrderItemResult">
        SELECT i.id, i.order_id, i.product_id, i.product_name, i.product_img, i.business_type, 
               i.price, i.quantity, i.rent_start_time, i.rent_end_time, i.rent_days, i.dept_id,
               i.deposit, i.overdue_deduct_days, o.user_id, o.deposit_amount, o.is_overdue
        FROM shop_order_item i
        INNER JOIN shop_order o ON i.order_id = o.order_id
        WHERE o.status = '2'
          AND i.business_type = '1'
          AND i.rent_end_time >= CURDATE()
          AND i.rent_end_time &lt;= DATE_ADD(CURDATE(), INTERVAL #{daysBeforeExpiry} DAY)
    </select>

    <!-- 查询指定用户即将到期的租赁订单明细（用于前端提醒） -->
    <select id="selectExpiringSoonItemsByUserId" resultMap="OverdueOrderItemResult">
        SELECT i.id, i.order_id, i.product_id, i.product_name, i.product_img, i.business_type, 
               i.price, i.quantity, i.rent_start_time, i.rent_end_time, i.rent_days, i.dept_id,
               i.deposit, i.overdue_deduct_days, o.user_id, o.deposit_amount, o.is_overdue
        FROM shop_order_item i
        INNER JOIN shop_order o ON i.order_id = o.order_id
        WHERE o.user_id = #{userId}
          AND o.status = '2'
          AND i.business_type = '1'
          AND i.rent_end_time >= CURDATE()
          AND i.rent_end_time &lt;= DATE_ADD(CURDATE(), INTERVAL #{daysBeforeExpiry} DAY)
    </select>
</mapper>