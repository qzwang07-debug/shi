# 首页热门推荐商品优化实施计划

## 目标
将首页热门推荐区域固定为3个商品，优先展示协同过滤推荐商品，不足时随机补充。

## 实施步骤

### 1. 修改首页商品获取逻辑
**文件**: `d:\code\zNova\zNova-ui\src\views\computerMarket\mallHome.vue`

**修改内容**:
- 复用出售/租赁页面的 `recommendFirst()` 和 `shuffleInPlace()` 函数
- 修改 `getProductData()` 函数：
  - 获取所有可用商品（包括出售和租赁）
  - 调用 `getPersonalRecommend(3)` 获取推荐商品ID
  - 使用 `recommendFirst()` 将推荐商品优先排序
  - **截取前3个商品**（核心修改点）
  - 确保无论推荐数量多少，最终只显示3个商品

### 2. 具体代码修改

#### 2.1 添加辅助函数（从出售页面复制）
```javascript
const shuffleInPlace = (list) => {
  for (let i = list.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1))
    const temp = list[i]
    list[i] = list[j]
    list[j] = temp
  }
  return list
}

const recommendFirst = (allProducts, recommendedIds = []) => {
  const recommendedIdSet = new Set(recommendedIds)
  const productById = new Map(allProducts.map(p => [p.id, p]))

  const recommended = []
  const added = new Set()
  for (const id of recommendedIds) {
    if (added.has(id)) continue
    const product = productById.get(id)
    if (!product) continue
    recommended.push(product)
    added.add(id)
  }

  const others = allProducts.filter(p => !recommendedIdSet.has(p.id))
  shuffleInPlace(others)
  return [...recommended, ...others]
}
```

#### 2.2 修改 getProductData 函数
```javascript
const getProductData = async () => {
  try {
    // 获取所有商品（出售+租赁）
    const response = await listFrontProduct({
      minId: 4,
      pageSize: 1000
    });
    
    if (response.rows && response.rows.length > 0) {
      const validProducts = response.rows.filter(product => product.id >= 4);
      
      // 获取推荐商品ID
      let recommendedIds = [];
      try {
        const recommendRes = await getPersonalRecommend(3); // 只请求3个推荐
        recommendedIds = (recommendRes.data || []).map(p => p.id).filter(Boolean);
      } catch (e) {
        console.warn('获取推荐商品失败，将随机展示', e);
      }

      // 推荐优先排序
      const orderedProducts = recommendFirst(validProducts, recommendedIds);
      
      // 【核心修改】固定取前3个商品
      productList.value = orderedProducts.slice(0, 3);
    } else {
      productList.value = [];
    }
  } catch (error) {
    console.error('获取商品数据失败:', error);
    productList.value = [];
  }
};
```

#### 2.3 更新导入语句
添加：
```javascript
import { listFrontProduct } from "@/api/front/product";
```

### 3. 验证要点
- ✅ 首页热门推荐区域只显示3个商品
- ✅ 协同过滤推荐商品优先展示
- ✅ 推荐不足时用随机商品补充
- ✅ 支持出售和租赁两种类型商品

## 预期效果
- 首页热门推荐区域固定显示3个商品卡片
- 推荐算法计算出的商品会排在前面
- 如果推荐少于3个，自动用随机商品补齐
- 保持与出售/租赁页面一致的推荐逻辑